<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>向商家付款</title>
    <link rel="stylesheet" type="text/css" href="__TMPL__Public/pay/version1/css/index-rem.css">
    <link rel="stylesheet" type="text/css" href="__TMPL__Public/pay/version1/css/member.css">
    <link rel="stylesheet" href="__TMPL__Public/pay/version1/js/layer_mobile/need/layer.css">
</head>

<body style="background:#f2f2f2;">
<!-- 头部区域 -->
<!--<div class="header">-->
    <!--<a onclick="javascript:history.back();"><img src="__TMPL__Public/pay/version1/imgs/rignarr.png" /></a>-->
    <!--<h4>向商家付款</h4>-->
<!--</div>-->

<!-- 内容部分 -->
<div class="conter">
    <h5>{$merchant['jianchen']}</h5>
    <div class="conter_box">
        <p class="conter_left">已优惠 <span>￥</span><span class="discount">0</span> , <a href="javascript:void(0);" onclick="myjs()">点击查看</a></p>
        <p class="conter_right">应付金额：<span class="payables">￥0.00</span></p>
    </div>
    <div class="conter_key">
        <p class='key-title'>消费金额 <span class='input-box'>元</span> <input type="text" id="content" placeholder="请输入消费金额" readonly> </p>
    </div>
    <ul id="test">
        <h6>请选择付款方式</h6>
        <if condition="isset($agent_yue) && ($agent_yue nheq '')">
            <li>
                <img src="__TMPL__Public/pay/version1/imgs/222_02.png" alt="">
                <span>储值支付</span>
                <span class="ul_s">￥{$agent_yue|floatval}</span>
                <input type="checkbox" name="check1" value="储值支付">
            </li>
        <elseif condition="isset($yue) && ($yue nheq '')"/>
            <li>
                <img src="__TMPL__Public/pay/version1/imgs/222_02.png" alt="">
                <span>储值支付</span>
                <span class="ul_s">￥{$yue|floatval}</span>
                <input type="checkbox" name="check1" value="储值支付">
            </li>
        <else/>
            <!--<li>-->
                <!--<img src="__TMPL__Public/pay/version1/imgs/222_02.png" alt="">-->
                <!--<span>储值支付</span>-->
                <!--<span class="ul_s">￥10</span>-->
                <!--<input type="checkbox" name="check1" value="储值支付">-->
            <!--</li>-->
        </if>
        <li>
            <img src="__TMPL__Public/pay/version1/imgs/222_03.png" alt="">
            <span>微信支付</span>
            <input type="checkbox" name="check1" value="微信支付">
        </li>
    </ul>
</div>

<!-- 安全键盘 -->
<div class='key-container'>
    <div class='keyboard'>
        <div class='key-row'>
            <div class='key-cell' data-num='7' ontouchend="demo(this,1)">7</div>
            <div class='key-cell' data-num='8' ontouchend="demo(this,1)">8</div>
            <div class='key-cell' data-num='9' ontouchend="demo(this,1)">9</div>
            <div class='key-cell keyimg' data-num='D' onclick="demo(this,2)"></div>
        </div>
        <div class='key-row'>
            <div class='key-cell' data-num='4' onclick="demo(this,1)">4</div>
            <div class='key-cell' data-num='5' onclick="demo(this,1)">5</div>
            <div class='key-cell' data-num='6' onclick="demo(this,1)">6</div>
            <div class='key-cell' data-num='-1'></div>
        </div>
        <div class='key-row'>
            <div class='key-cell' data-num='1' onclick="demo(this,1)">1</div>
            <div class='key-cell' data-num='2' onclick="demo(this,1)">2</div>
            <div class='key-cell' data-num='3' onclick="demo(this,1)">3</div>
            <div class='key-cell' data-num='-1'></div>
        </div>
        <div class='key-row'>
            <div class='key-cell key0' data-num='0' onclick="demo(this,1)">0</div>
            <div class='key-cell' data-num='.' onclick="demo(this,1)">.</div>
            <div class='key-cell' data-num='-1'></div>
        </div>
        <div class='key-confirm' data-num='S' onclick="handleConfirmKey()">
            <p>确认支付</p>
        </div>
    </div>
</div>
<!-- 查看优惠卷 -->
<div class="oooo">
    <div class="xx" onclick="closex()">X</div>
    <div class="oooo1">
        <!--代理商联盟卡-->
        <if condition="!empty($agent_discount)">
            <ul>
                <p><span>宝安商圈卡</span><span class="right">银卡会员</span></p>
                <li>
                    <span>会员折扣 ({$agent_discount}折)</span>
                    <input type="checkbox" name="check2" value="0">
                    <span class="right">-￥0</span>
                </li>
                <if condition="$agent_credits neq 0">
                    <li>
                        <span>积分抵扣 (使用0积分)</span>
                        <input type="checkbox" name="check2" value="0">
                        <span class="right">-￥0</span>
                    </li>
                </if>
            </ul>
        </if>
        <!--代理商联盟卡-->
        <!--商家会员卡-->
        <if condition="!empty($discount)">
            <ul>
                <p><span>宝安商圈卡</span><span class="right">银卡会员</span></p>
                <li class="discount mch">
                    <span>会员折扣 ({$discount}折)</span>
                    <input type="checkbox" name="check2" value="0">
                    <span class="right">-￥0</span>
                </li>
                <if condition="$credits neq 0">
                    <li>
                        <span>积分抵扣 (使用0积分)</span>
                        <input type="checkbox" name="check2" value="0">
                        <span class="right">-￥0</span>
                    </li>
                </if>
            </ul>
        </if>
        <!--商家会员卡-->
        <!--优惠券-->
        <if condition="!empty($coupon_data)">
            <ul>
                <p><span>优惠券</span><span class="right">满减</span></p>
                    <volist  name="coupon_data" id="v">
                        <li man="{$v.total_price}" jian="{$v.de_price}" code="{$v.usercard}" class="coupon">
                            <span>满{$v.total_price}减{$v.de_price}优惠券</span>
                            <input type="checkbox" name="check2" value="{$v.de_price}">
                            <span class="right">-￥{$v.de_price}</span>
                        </li>
                    </volist>
            </ul>
        </if>
        <!--优惠券-->

    </div>
</div>
<div class="motai"></div>
<!-- 请输入支付密码 -->
<div class="pay">
    <div class="payment">
        <h6>请输入支付密码<span onclick="closeXX()">X</span></h6>
        <p>会员卡储值支付</p>
        <p class="payment_bot">￥5.00</p>
        <div class="cell_input">
            <input type="password" name="" id="pay_content" maxlength="6" style="display: none;" />
            <div>
                <input type="password" name="password" id="inputValue0" maxlength="1" readonly/>
                <input type="password" name="password" id="inputValue1" maxlength="1" readonly/>
                <input type="password" name="password" id="inputValue2" maxlength="1" readonly/>
                <input type="password" name="password" id="inputValue3" maxlength="1" readonly/>
                <input type="password" name="password" id="inputValue4" maxlength="1" readonly/>
                <input type="password" name="password" id="inputValue5" maxlength="1" readonly/>
            </div>
        </div>
    </div>
    <!-- 安全键盘 -->
    <div class='key-password'>
        <div class='keyboard'>
            <div class='key-row'>
                <div class='key-cell' data-num='1' onclick="passworddemo(this,1)">1</div>
                <div class='key-cell' data-num='2' onclick="passworddemo(this,1)">2</div>
                <div class='key-cell' data-num='3' onclick="passworddemo(this,1)">3</div>
            </div>
            <div class='key-row'>
                <div class='key-cell' data-num='4' onclick="passworddemo(this,1)">4</div>
                <div class='key-cell' data-num='5' onclick="passworddemo(this,1)">5</div>
                <div class='key-cell' data-num='6' onclick="passworddemo(this,1)">6</div>
            </div>
            <div class='key-row'>
                <div class='key-cell' data-num='7' onclick="passworddemo(this,1)">7</div>
                <div class='key-cell' data-num='8' onclick="passworddemo(this,1)">8</div>
                <div class='key-cell' data-num='9' onclick="passworddemo(this,1)">9</div>
            </div>
            <div class='key-row'>
                <div class='key-cell cell' data-num='-1'></div>
                <div class='key-cell' data-num='0' onclick="passworddemo(this,1)">0</div>
                <div class='key-cell passwordimg' data-num='D' onclick="passworddemo(this,2)"></div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" name="seller_id" value="{$seller_id}">
<input type="hidden" name="openid" value="{$openid}">
<input type="hidden" name="checker_id" value="{$checker_id|0}">
<input type="hidden" name="agent_yue" value="{$agent_yue|0}">
<input type="hidden" name="mch_yue" value="{$yue|0}">

</body>
<script src="__TMPL__Public/pay/version1/js/jquery.min.js"></script>
<script src="__TMPL__Public/pay/version1/js/layer_mobile/layer.js"></script>
</html>
<script>
    var flag = {$flag};
    var mch_id ={$merchant.merchant_id|default=0};
</script>
<script type="text/javascript">
    if(!flag){
        $(".conter_left").hide();
    }
    var test_val; //支付方式
    var oooo1_val; //优惠卷的值
    var payables_val; //应付金额
    // $(document).ready(function() {
    //     // JQuery 实现多个checkbox 只选中一个
    //     $('#test').find('input[type=checkbox]').bind('click', function() {
    //         $('#test').find('input[type=checkbox]').not(this).attr("checked", false);
    //         test_val = $(this).val();
    //     });
    //     $('.oooo1').find('input[type=checkbox]').bind('click', function() {
    //         $('.oooo1').find('input[type=checkbox]').not(this).attr("checked", false);
    //         oooo1_val = $(this).val();
    //     });
    // })
    //点击查看优惠卷
    function myjs() {
        $('.oooo').show();
        $('.motai').show();
    }
    //点击优惠卷关闭的时候取值
    function closex() {
        $('.oooo').hide();
        $('.motai').hide();
        $(".discount").text(oooo1_val); //把值放到已优惠里面
    }
    //处理按键
    function demo(obj, tip) {
        var con = $('#content').val();
        var num;    //点击按钮的值
        if (tip == 1) {
            num = con + $(obj).html();
            if(num !=''&& num.substr(0,1) == '.'){num="";}
            num = num.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
            num = num.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
            num = num.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
            num = num.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数
            // 此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            if(num.indexOf(".")< 0 && num !="") {
                if (num.substr(0, 1) == '0' && num.length == 2) {
                    num = num.substr(1, num.length);
                }
            }
            if(num<=99999.99 && num.toString().length<=8){
                if(num.indexOf(".")>0){
                    num = num.replace(/\b(0+)/gi,"0");
                    if(num.toString().split(".")[1].length<=2){
                    } else {
                        num = num.substr(0, num.length - 1);
                    }
                }
            } else {
                num =  num.substr(0, num.length - 1);
            }
            if(num>0){  $(".key-confirm").css('background','#329CFF'); }
            $('#content').attr('value', num);
            // 应付金额
            payables();
        } else if (tip == 2) { //处理删除键
            num = con.slice(0,-1);
            $('#content').attr('value', con.slice(0, -1));
            if(num < 0.01){
                $(".key-confirm").css('background','#98CDFF');
            }
            // 应付金额
            payables();
        }
    }
    //应付金额
    function payables() {
        var discount = $(".discount").html();
        payables_val = parseFloat(document.getElementById('content').value - discount);
        if (document.getElementById('content').value < 10) {
            $(".payables").text('￥' + document.getElementById('content').value);
        } else {
            $(".payables").text('￥' + payables_val);
        }
    }
    // 确认
    function handleConfirmKey() {
        let S = $('#content').val();
        //未输入
        if (!S.length || payables_val <= 0) {
            layer.open({
                content: '请输入消费金额',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return false;
        }
        if (test_val == '储值支付') {
            $('.pay').show();
            $('.motai').show();
            $(".payment_bot").text('￥' + payables_val);
        } else if (test_val == '微信支付') {
            $('.pay').show();
            $('.motai').show();
            $(".payment_bot").text('￥' + payables_val);
        } else {
            layer.open({
                content: '请选择支付方式',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return false;
        }
    }
    //支付按键
    function passworddemo(obj, tip) {
        var pay = $('#pay_content').val();
        if (tip == 1) {
            if (pay.length == 5) {
                $('#pay_content').attr('value', pay + obj.innerHTML);
                $('#inputValue5').attr('value', obj.innerHTML);
                // 发送请求接口
                //如果失败弹出询问框
                layer.open({
                    title: [
                        '提示',
                        'color:#323232'
                    ],
                    content: '支付密码错误!',
                    btn: ['重试', '忘记密码'],
                    yes: function(index) { //点击重试
                        $('input[name=password]').val('');
                        $('#pay_content').attr('value', "");
                        layer.close(index);
                    },
                    no: function(index) { //忘记密码
                        console.log(111)
                        // layer.close(index);
                    },
                });
                return false;
            } else {
                $('#pay_content').attr('value', pay + obj.innerHTML);
                for (var i = 0; i < document.getElementById('pay_content').value.length; i++) {
                    if (pay.length == i) {
                        $('#inputValue' + i).attr('value', obj.innerHTML);
                    }
                }
            }
        } else if (tip == 2) { //处理删除键
            $('input[name=password]').val('');
            document.getElementById('pay_content').value = pay.slice(0, -1);
            for (var i = 0; i < document.getElementById('pay_content').value.length; i++) {
                $('#inputValue' + i).attr('value', document.getElementById('pay_content').value[i]);
            }
        }
    }
    //支付按键关闭
    function closeXX() {
        $('.pay').hide();
        $('.motai').hide();
    }

    //功能：将浮点数四舍五入，取小数点后2位
    function toDecimal(x) {
        var f = parseFloat(x);
        if (isNaN(f)) {
            return x;
        }
        f = Math.round(x*100)/100;
        return f;
    }
</script>