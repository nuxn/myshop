<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>向商家付款</title>
    <link rel="stylesheet" type="text/css" href="__TMPL__Public/pay/version1/css/index-rem.css">
    <link rel="stylesheet" type="text/css" href="__TMPL__Public/pay/version1/css/member.css">
    <link rel="stylesheet" href="__TMPL__Public/pay/version1/js/layer_mobile/need/layer.css">
</head>

<body style="background:#f2f2f2;">

<!-- 内容部分 -->
<div class="conter">
    <h5>{$merchant['jianchen']}</h5>
    <div class="conter_box">
        <p class="conter_right">应付金额：<span class="payables">￥0</span></p>
    </div>
    <div class="conter_key">
        <p class='key-title'>消费金额 <span class='input-box'>元</span> <input type="text" id="content" placeholder="请输入消费金额"
                                                                          readonly></p>
    </div>
    <ul>
        <h6>请选择付款方式</h6>
        <li>
            <img src="__TMPL__Public/pay/version1/imgs/222_01.png" alt="">
            <span>支付宝支付</span>
            <input type="checkbox" name="zfb" checked disabled>
        </li>
    </ul>
</div>


<!-- 安全键盘 -->
<div class='key-container'>
    <div class='keyboard'>
        <div class='key-row'>
            <div class='key-cell' data-num='7' onclick="demo(this,1)">7</div>
            <div class='key-cell' data-num='8' onclick="demo(this,1)">8</div>
            <div class='key-cell' data-num='9' onclick="demo(this,1)">9</div>
            <div class='key-cell keyimg' data-num='D' onclick="demo(this,2)"></div>
        </div>
        <div class='key-row'>
            <div class='key-cell' data-num='4' onclick="demo(this,1)">4</div>
            <div class='key-cell' data-num='5' onclick="demo(this,1)">5</div>
            <div class='key-cell' data-num='6' onclick="demo(this,1)">6</div>
            <div class='key-cell' data-num='-1'></div>
        </div>
        <div class='key-row'>
            <div class='key-cell' data-num='1' onclick="demo(this,1)">1</div>
            <div class='key-cell' data-num='2' onclick="demo(this,1)">2</div>
            <div class='key-cell' data-num='3' onclick="demo(this,1)">3</div>
            <div class='key-cell' data-num='-1'></div>
        </div>
        <div class='key-row'>
            <div class='key-cell key0' data-num='0' onclick="demo(this,1)">0</div>
            <div class='key-cell' data-num='.' onclick="demo(this,1)">.</div>
            <div class='key-cell' data-num='-1'></div>
        </div>
        <div class='key-confirm' data-num='S' onclick="handleConfirmKey()">
            <p>确认支付</p>
        </div>
    </div>
</div>
<div class="motai"></div>

<input type="hidden" name="seller_id" value="{$seller_id}">
<input type="hidden" name="checker_id" value="{$checker_id|default=0}">
</body>
<script src="__TMPL__Public/pay/version1/js/jquery.min.js"></script>
<script src="__TMPL__Public/pay/version1/js/layer_mobile/layer.js"></script>

</html>
<script type="text/javascript">
    var click = 0;
    var payables_val; //应付金额
    $(document).ready(function () {

    })

    //处理按键
    function demo(obj, tip) {
        var con = $('#content').val();
        var num;    //点击按钮的值
        if (tip == 1) {
            num = con + $(obj).html();
            if (num != '' && num.substr(0, 1) == '.') {
                num = "";
            }
            num = num.replace(/[^\d.]/g, "");  //清除“数字”和“.”以外的字符
            num = num.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的
            num = num.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
            num = num.replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3');//只能输入两个小数
            // 此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            if (num.indexOf(".") < 0 && num != "") {
                if (num.substr(0, 1) == '0' && num.length == 2) {
                    num = num.substr(1, num.length);
                }
            }
            if (num <= 99999.99 && num.toString().length <= 8) {
                if (num.indexOf(".") > 0) {
                    num = num.replace(/\b(0+)/gi, "0");
                    if (num.toString().split(".")[1].length <= 2) {
                    } else {
                        num = num.substr(0, num.length - 1);
                    }
                }
            } else {
                num = num.substr(0, num.length - 1);
            }
            if (num > 0) {
                $(".key-confirm").css('background', '#329CFF');
            }
            $('#content').attr('value', num);
            // 应付金额
            payables();
        } else if (tip == 2) { //处理删除键
            num = con.slice(0, -1);
            $('#content').attr('value', con.slice(0, -1));
            if (num < 0.01) {
                $(".key-confirm").css('background', '#98CDFF');
            }
            // 应付金额
            payables();
        }
    }

    //应付金额
    function payables() {
        payables_val = toDecimal(document.getElementById('content').value);
        $(".payables").text('￥' + document.getElementById('content').value);
    }

    // 确认
    function handleConfirmKey() {
        let S = $('#content').val();
        //未输入
        if (!S.length || payables_val <= 0) {
            layer.open({
                content: '请输入消费金额',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return false;
        }
        var money = payables_val;
        var seller_id = $("input[name=seller_id]").val();
        var checker_id = $("input[name=checker_id]").val();
        // var memo = $("input[name=memo]").val();
        console.log(click);
        if (click < 1) {
            console.log(money);
            if (money > 0) {
                click += 1;
                $('.key-confirm').removeAttr('onclick');//去掉a标签中的onclick事件
                var price = parseFloat(money) + "/seller_id/" + seller_id + "/checker_id/" + checker_id;
                location = "http://sy.youngport.com.cn/index.php?s=/Pay/Barcodembank/qr_to_alipay/price/" + price;
            }
        }
    }

    //功能：将浮点数四舍五入，取小数点后2位
    function toDecimal(x) {
        var f = parseFloat(x);
        if (isNaN(f)) {
            return 0;
        }
        f = Math.round(x * 100) / 100;
        return f;
    }
</script>