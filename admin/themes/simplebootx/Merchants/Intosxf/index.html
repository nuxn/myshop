<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/layui/css/layui.css">
    <script src="__PUBLIC__/layui/layui.all.js"></script>
    <script src="__PUBLIC__/js/jquery.js"></script>
    <style>
        a{color:#0e90d2}
    </style>
</head>
<body>

<div class="layui-tab">
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
            <!--<blockquote class="layui-elem-quote layui-text">-->

            <!--</blockquote>-->
                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <a class="layui-btn layui-btn-normal layui-btn-sm" lay-event="detail" href="{:U('add',array('id'=>$val['id']))}">添加进件</a>
                        <div class="layui-inline">
                            <label class="layui-form-label">商户Id</label>
                            <div class="layui-input-inline">
                                <input type="tel" name="merchant_id" value="{$map.merchant_id|default=''}" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">商户名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="mch_name" value="{$map.mch_name|default=''}" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">绑定公众号</label>
                            <div class="layui-input-inline">
                                <select name="bandconf">
                                    <option value="0" <if condition="$map['bandconf'] eq 0">selected</if>>选择</option>
                                    <option value="1" <if condition="$map['bandconf'] eq 1">selected</if>>已绑定</option>
                                    <option value="2" <if condition="$map['bandconf'] eq 2">selected</if>>未绑</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">随行付Id</label>
                            <div class="layui-input-inline">
                                <input type="tel" name="mno" value="{$map.mno|default=''}" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <button class="layui-btn layui-btn-sm" lay-submit lay-filter="search">搜索</button>
                                <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="detail" href="{:U('index')}">重置</a>
                            </div>
                        </div>
                    </div>
                </form>
            <hr class="layui-bg-orange">
            <div class="layui-form">
                <table class="layui-table">
                    <colgroup>
                        <col width="50">
                        <col width="250">
                        <col width="150">
                        <col width="175">
                        <col width="100">
                        <col width="75">
                        <col width="170">
                        <col>
                    </colgroup>
                    <thead>
                    <tr>
                        <th>id</th>
                        <th>商户名称</th>
                        <th>商户号</th>
                        <th>任务编号</th>
                        <th>进件状态</th>
                        <th>费率</th>
                        <th>进件时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <foreach name="info" item="val">
                        <tr data-id="{$val.id}" class="parents" data-dis="0">
                            <td>{$val.id}</td>
                            <td>{$val.merchant_name}</td>
                            <td>{$val.mno}</td>
                            <td>{$val.task_code}</td>
                            <td>
                                <switch name="val.status">
                                    <case value="0">未进件</case>
                                    <case value="1">审核中<i class="layui-icon layui-icon-loading" style="font-size: 20px; color: #0000cc;"></i></case>
                                    <case value="2">通过<i class="layui-icon layui-icon-ok" style="font-size: 20px; color: #1eb9c1;"></i></case>
                                    <case value="3">驳回<i class="layui-icon layui-icon-close" style="font-size: 20px; color: #F32043;"></i></case>
                                    <case value="4">分店<i class="layui-icon layui-icon-ok" style="font-size: 20px; color: #1eb9c1;"></i></case>
                                    <default />等待
                                </switch>
                            </td>
                            <td>{$val.qrcodeRate}%</td>
                            <td>{$val.add_time}</td>
                            <td>
                                <if condition="$val.status neq 4">
                                <div class="layui-table-cell laytable-cell-1-10">
                                    <if condition="$val['status'] eq 0">
                                        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail" href="{:U('edit',array('id'=>$val['id'],'edit'=>1))}">进件</a>
                                        <else/>
                                        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail" href="{:U('edit',array('id'=>$val['id'],'edit'=>0))}">查看</a>
                                    </if>
                                    <if condition="$val['subMchId'] eq 0">
                                        <button class="layui-btn layui-btn-xs" type="button" data-id="{$val.id}" data-mno="{$val.mno}" onclick="wxconfig(this)">配置公众号支付</button>
                                        <else/>
                                        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="detail" href="{:U('wxconfig',array('id'=>$val['id'],'see'=>1))}">查看公众号</a>
                                    </if>
                                    <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="detail" href="{:U('same',array('merchant_id'=>$val['merchant_id'],'id'=>$val['id']))}">分店</a>
                                    <if condition="$val['status'] neq 2">
                                        <button class="layui-btn layui-btn-xs layui-btn-danger" type="button" data-msg="{$val.err_msg}" id="tips{$val.id}" onclick="tipsdis(this)">失败原因</button>
                                    </if>
                                </div>
                                </if>
                            </td>
                        </tr>
                    </foreach>
                    </tbody>
                </table>
                {$page}
            </div>
        </div>
    </div>
</div>
<script>
    function tipsdis(obj) {
        var msg = $(obj).data('msg');
        var id = $(obj).attr('id');
        console.log(id);
        layer.tips(msg, '#'+id, {
            tips: [1, '#000000'],
            time: 8000
        });
    }

    var open;

    layui.use('form', function () {
        var form = layui.form;
        form.render();
        //监听提交
        form.on('submit(search)', function (data) {
            var send = JSON.stringify(data.field);
            send = eval('(' + send + ')')
            var str = '';
            $.each(send,function (ke,val) {
                str += '&'+ke+'='+val;
            });
            var url = "{:U('index')}"+str;
            location.href = url;
            return false;
        });
        form.on('submit(formSub)', function (data) {
            var send = JSON.stringify(data.field);
            send = eval('(' + send + ')')
            var index = layer.load(0, {
                shade: [0.3, '#000'] //0.1透明度的白色背景
            });
            $.post("{:U('wxconfig')}", send, function (res) {
                if (res.code == '0000') {
                    var al = layer.alert('配置成功', {icon: 1},function(){
                        layer.close(al);
                        layer.close(open);
                        location.reload();
                    })
                } else {
                    if(res.code == '1000'){layer.open({title: 'APPID 配置失败', content: res.msg});}
                    if(res.code == '2000'){layer.open({title: '授权目录配置失败', content: res.msg});}
                    if(res.code == '3000'){layer.open({title: '推荐关注配置失败', content: res.msg});}

                }
                layer.close(index);
            });
            return false;
        });
    });
    function wxconfig(obj) {
        var id = $(obj).data('id');
        var mno = $(obj).data('mno');
            if(true){
            // if(res.code == '0000'){
                open = layer.open({
                title: '随行付商户公众号配置',
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                area: ['650px', '380'], //宽高
                content: '<div class="layui-row">\n' +
                '        <div class="layui-col-md12">\n' +
                '                <div class="layui-field-box">\n' +
                '                    <form class="layui-form layui-form-pane" action="">\n' +
                '                        <div class="layui-form-item">\n' +
                '                            <label class="layui-form-label">微信商户号</label>\n' +
                '                            <div class="layui-input-block">\n' +
                '                                <input type="text" name="subMchId" lay-verify="required" value=""\n' +
                '                                       autocomplete="off" class="layui-input">\n' +
                '                            </div>\n' +
                '                        </div>\n' +
                '                        <div class="layui-form-item">\n' +
                '                            <label class="layui-form-label">APPID</label>\n' +
                '                            <div class="layui-input-block">\n' +
                '                                <input type="text" name="subAppid" required lay-verify="required"\n' +
                '                                       value="wx3fa82ee7deaa4a21" autocomplete="off" class="layui-input">\n' +
                '                            </div>\n' +
                '                        </div>\n' +
                '\n' +
                '                        <div class="layui-form-item">\n' +
                '                            <label class="layui-form-label">授权目录</label>\n' +
                '                            <div class="layui-input-block">\n' +
                '                                <input type="text" name="jsapiPath" lay-verify="required" value="https://sy.youngport.com.cn/"\n' +
                '                                       autocomplete="off" class="layui-input">\n' +
                '                            </div>\n' +
                '                        </div>\n' +
                '                        <div class="layui-form-item">\n' +
                '                            <label class="layui-form-label">推荐关注公众号</label>\n' +
                '                            <div class="layui-input-block">\n' +
                '                                <input type="text" name="subscribeAppid" lay-verify="" value=""\n' +
                '                                       autocomplete="off" class="layui-input">\n' +
                '                            </div>\n' +
                '                        </div>\n' +
                '\n' +
                '                        <input type="hidden" name="mno" value="'+mno+'">\n' +
                '                        <input type="hidden" name="id" value="'+id+'">\n' +
                '\n' +
                '                        <div class="layui-form-item">\n' +
                '                            <div class="layui-input-block">\n' +
                '                                <if condition="$see eq 0">\n' +
                '                                    <button class="layui-btn layui-btn-normal " lay-submit lay-filter="formSub">立即提交</button>\n' +
                '                                </if>\n' +
                '                            </div>\n' +
                '                        </div>\n' +
                '                    </form>\n' +
                '                </div>\n' +
                '        </div>\n' +
                '    </div>'
            });
        }
    }

</script>

</body>
</html>